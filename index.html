<!DOCTYPE html>
<html lang="vi" data-theme="sunset">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Love Schedule</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --ease-ios: cubic-bezier(0.32, 0.72, 0, 1);
        }

        /* THEMES */
        [data-theme="sunset"] {
            --bg-grad: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            --glass: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.5);
            --surface: #ffffff;
            --text-main: #4a044e;
            --text-sub: #9d174d;
            --primary: #db2777;
            --secondary: #4f46e5;
            --accent: #f472b6;
            --now-color: #ef4444;
        }

        [data-theme="ocean"] {
            --bg-grad: linear-gradient(135deg, #a5f3fc 0%, #2563eb 100%);
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #334155;
            --primary: #0284c7;
            --secondary: #0ea5e9;
            --accent: #38bdf8;
            --now-color: #ef4444;
        }

        [data-theme="dark"] {
            --bg-grad: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --primary: #818cf8;
            --secondary: #c084fc;
            --accent: #6366f1;
            --now-color: #f87171;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background: #f0f2f5; 
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* --- 2. MOBILE FRAME WRAPPER --- */
        #mobile-frame {
            width: 100%; height: 100%;
            background: var(--bg-grad);
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            #mobile-frame {
                width: 375px; height: 812px;
                border-radius: 40px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: 8px solid #111;
            }
        }

        /* --- 3. LOADING --- */
        #splash {
            position: absolute; inset: 0; z-index: 9999;
            background: var(--surface);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.6s var(--ease-ios);
        }
        .loader-ring {
            width: 50px; height: 50px; border: 4px solid var(--primary);
            border-top-color: transparent; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 4. HEADER UI --- */
        header {
            flex: none; z-index: 50;
            background: var(--glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding-top: max(10px, var(--safe-top));
            border-radius: 0 0 24px 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px 5px 20px;
        }
        .brand { font-size: 20px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .live-dot {
            width: 8px; height: 8px; background: #22c55e; border-radius: 50%;
            display: inline-block; margin-left: 5px; box-shadow: 0 0 10px #22c55e;
            animation: pulse 2s infinite;
        }
        
        .btn-icon {
            width: 40px; height: 40px; border-radius: 12px;
            border: 1px solid var(--glass-border); background: rgba(255,255,255,0.2);
            color: var(--text-main); font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }

        /* WEEK TOGGLE */
        .week-toggle {
            display: flex; background: rgba(0,0,0,0.05); border-radius: 20px; margin: 0 20px 10px 20px; padding: 4px;
        }
        .week-btn {
            flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 700;
            color: var(--text-sub); border-radius: 16px; transition: 0.3s;
            cursor: pointer;
        }
        .week-btn.active { background: var(--surface); color: var(--text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .date-strip {
            display: flex; gap: 10px; overflow-x: auto;
            padding: 0 20px 15px 20px;
            scrollbar-width: none;
        }
        .day-chip {
            flex: 0 0 55px; height: 70px;
            background: var(--surface);
            border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid transparent;
            transition: all 0.3s var(--ease-ios);
            cursor: pointer; position: relative; overflow: hidden;
        }
        .day-chip.active {
            background: var(--primary); color: white;
            box-shadow: 0 8px 20px -5px var(--primary);
            transform: translateY(-4px);
        }
        .day-chip span:first-child { font-size: 11px; font-weight: 600; opacity: 0.8; margin-bottom: 4px; }
        .day-chip span:last-child { font-size: 18px; font-weight: 800; }

        /* --- 5. MAIN TIMELINE --- */
        #main-view {
            flex: 1; overflow-y: auto; position: relative;
            scroll-behavior: smooth;
            padding-bottom: 100px;
            background: rgba(255,255,255,0.3);
        }
        
        .sticky-user-bar {
            position: sticky; top: 0; z-index: 40;
            display: flex; padding: 10px; gap: 10px;
            background: var(--glass); backdrop-filter: blur(10px);
            margin: 10px; border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .user-pill {
            flex: 1; padding: 8px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            font-weight: 700; font-size: 13px; cursor: pointer;
            transition: 0.2s; background: rgba(255,255,255,0.5);
            color: var(--text-main); position: relative;
        }
        .user-pill:active { transform: scale(0.96); }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: white; display:flex; align-items:center; justify-content:center; font-size:12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Pet & Points */
        .pet-icon { font-size: 20px; animation: bounce 2s infinite; }
        .points-badge { 
            background: var(--text-main); color: white; padding: 2px 6px; 
            border-radius: 10px; font-size: 10px; font-weight: 800; margin-left: 4px; 
        }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-3px);} }

        /* GRID */
        .grid-wrapper {
            position: relative; margin-top: 5px;
            height: 1920px; /* 24h * 80px */
            background-image: linear-gradient(var(--glass-border) 1px, transparent 1px);
            background-size: 100% 80px;
        }
        
        .time-marker {
            position: absolute; left: 10px; width: 40px; 
            font-size: 11px; font-weight: 600; color: var(--text-sub);
            display: flex; align-items: center; padding-top: 2px;
        }

        .col-area {
            position: absolute; top: 0; bottom: 0;
            width: calc(50% - 35px); 
        }
        #col-giang { left: 50px; border-right: 1px dashed rgba(0,0,0,0.1); }
        #col-huyen { left: calc(50% + 15px); }

        /* TASK CARD */
        .task {
            position: absolute; left: 4px; right: 4px;
            border-radius: 14px; padding: 8px;
            color: white; font-size: 12px; font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer; overflow: hidden;
            animation: popIn 0.4s var(--ease-ios);
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px); transition: 0.2s;
        }
        .task.done { opacity: 0.6; filter: grayscale(0.8); }
        .task.u-Giang { background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); }
        .task.u-Huyen { background: linear-gradient(135deg, var(--accent) 0%, #db2777 100%); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; line-height: 1.2; }
        .task-time { font-size: 10px; opacity: 0.9; }
        .btn-check {
            width: 18px; height: 18px; border-radius: 50%; 
            border: 2px solid white; background: rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            margin-left: 4px; cursor: pointer; flex-shrink: 0;
        }
        .task.done .btn-check { background: #22c55e; border-color: #22c55e; }
        .btn-del {
            position: absolute; bottom: 5px; right: 5px;
            width: 20px; height: 20px; background: rgba(0,0,0,0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; opacity: 0; transition: 0.2s; font-size: 10px;
        }
        .task:hover .btn-del { opacity: 1; }

        /* UPGRADED REALTIME LASER LINE */
        #now-line {
            position: absolute; left: 0; right: 0; height: 2px; background: var(--now-color);
            z-index: 10; pointer-events: none;
            box-shadow: 0 0 10px var(--now-color), 0 0 20px var(--now-color);
            transition: top 1s linear;
        }
        #now-line::before {
            content:''; position: absolute; left: 45px; top: -4px;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--surface); border: 2px solid var(--now-color);
            box-shadow: 0 0 10px var(--now-color);
        }
        /* Time Indicator on Line */
        #now-line-time {
            position: absolute; right: 15px; top: -12px;
            background: var(--now-color); color: white;
            padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 800; letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* FAB & MODAL */
        .fab {
            position: absolute; bottom: 30px; right: 24px;
            width: 64px; height: 64px; border-radius: 24px;
            background: var(--text-main); color: var(--surface);
            border: none; font-size: 28px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 60; transition: transform 0.3s var(--ease-ios);
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        .modal-overlay {
            position: absolute; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: flex-end;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-card {
            width: 100%; background: var(--surface);
            border-radius: 32px 32px 0 0; padding: 24px;
            padding-bottom: max(30px, var(--safe-bottom));
            transform: translateY(100%); transition: transform 0.4s var(--ease-ios);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }
        .modal-overlay.open .modal-card { transform: translateY(0); }
        .handle { width: 40px; height: 5px; background: #e2e8f0; border-radius: 10px; margin: 0 auto 20px auto; }
        .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); }

        /* CUSTOM CONFIRM DIALOG */
        #dialog-overlay {
            position: absolute; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #dialog-overlay.show { opacity: 1; pointer-events: auto; }
        .dialog-box {
            width: 80%; background: var(--surface); padding: 20px;
            border-radius: 24px; text-align: center;
            transform: scale(0.9); transition: transform 0.2s var(--ease-ios);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        #dialog-overlay.show .dialog-box { transform: scale(1); }
        .dialog-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .d-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; font-family: var(--font-main);}
        .d-btn:active { transform: scale(0.95); }
        .d-btn.cancel { background: #f1f5f9; color: var(--text-sub); }
        .d-btn.confirm { background: var(--text-main); color: white; }

        /* FORM */
        .toggle-group { display: flex; background: #f1f5f9; padding: 5px; border-radius: 16px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 12px; font-weight: 700; color: var(--text-sub); transition: 0.2s; cursor: pointer; }
        .toggle-btn.active.g { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .toggle-btn.active.h { background: white; color: var(--accent); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .cat-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; margin-bottom: 10px; }
        .cat-btn { 
            padding: 10px 16px; border-radius: 20px; border: 1px solid var(--glass-border);
            background: #f8fafc; font-weight: 600; font-size: 13px; color: var(--text-sub);
            white-space: nowrap; cursor: pointer; transition: 0.2s; display: flex; gap: 6px;
        }
        .cat-btn.selected { background: var(--text-main); color: white; border-color: var(--text-main); transform: scale(1.05); }

        .inp-group { background: #f8fafc; border-radius: 16px; padding: 10px 16px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; border: 1px solid transparent; transition: 0.3s; }
        .inp-group:focus-within { background: white; border-color: var(--text-main); }
        .inp { border: none; background: transparent; width: 100%; font-size: 16px; font-weight: 600; outline: none; color: var(--text-main); }

        .btn-main {
            width: 100%; padding: 18px; border-radius: 20px;
            background: var(--text-main); color: white;
            border: none; font-size: 16px; font-weight: 800;
            margin-top: 10px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2);
        }
        .btn-main:active { transform: scale(0.98); }

        /* DUAL RANGE SLIDER */
        .slider-container { position: relative; width: 100%; height: 50px; margin-bottom: 20px; margin-top: 10px; }
        .slider-track { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; z-index: 1; }
        .slider-track-fill { position: absolute; top: 50%; transform: translateY(-50%); height: 6px; background: var(--primary); z-index: 2; border-radius: 3px; }
        .range-inp { position: absolute; top: 50%; transform: translateY(-50%); width: 100%; pointer-events: none; -webkit-appearance: none; z-index: 3; background: none; }
        .range-inp::-webkit-slider-thumb { -webkit-appearance: none; pointer-events: auto; width: 24px; height: 24px; border-radius: 50%; background: white; border: 2px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; }
        .time-display { display: flex; justify-content: space-between; font-weight: 800; color: var(--text-main); margin-bottom: 5px; font-size: 18px; }

        /* SMART DATING POPUP */
        .smart-dating-card { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border: 2px dashed #db2777; border-radius: 16px; padding: 15px; margin-top: 15px; text-align: center; display: none; animation: popIn 0.5s; }
        .smart-btn { background: #db2777; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 700; margin-top: 8px; cursor: pointer; box-shadow: 0 4px 10px rgba(219, 39, 119, 0.4); }

        /* HEART ANIMATION */
        .floating-heart { position: fixed; font-size: 24px; color: #db2777; pointer-events: none; z-index: 999; animation: floatUp 1.5s ease-out forwards; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-200px) scale(1.5); opacity: 0; } }

        /* STATS CSS */
        .cinema-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 15px; }
        .seat-item { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: white; transition: transform 0.2s; }
        .seat-item.free { background: #4ade80; box-shadow: 0 2px 5px rgba(74, 222, 128, 0.4); }
        .seat-item.mix { background: #fbbf24; box-shadow: 0 2px 5px rgba(251, 191, 36, 0.4); }
        .seat-item.busy { background: #ef4444; opacity: 0.4; }
        .session-title { font-size: 12px; font-weight: 800; color: var(--text-sub); margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; }
        .legend-row { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; background: #f8fafc; padding: 10px; border-radius: 12px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--text-sub); }
        .dot { width: 10px; height: 10px; border-radius: 3px; }
        .stats-verdict { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 16px; text-align: center; margin-top: 10px; box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3); animation: popIn 0.5s var(--ease-ios); }

        /* TOAST */
        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; font-weight: 600; z-index: 200; transition: transform 0.4s var(--ease-ios); display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); white-space: nowrap; }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="mobile-frame">
        
        <div id="splash">
            <div class="loader-ring"></div>
            <h2 style="margin-top:20px; font-size:16px; color:var(--text-sub)">ƒêang ƒë·ªìng b·ªô...</h2>
        </div>

        <div id="toast"><i class="fa-solid fa-check-circle" style="color:#4ade80"></i> <span>ƒê√£ l∆∞u th√†nh c√¥ng</span></div>

        <div id="dialog-overlay">
            <div class="dialog-box">
                <div style="font-size:40px; margin-bottom:10px">ü§î</div>
                <div style="font-weight:800; font-size:18px; color:var(--text-main); margin-bottom:5px" id="d-title">X√°c nh·∫≠n</div>
                <div style="color:var(--text-sub); font-size:14px" id="d-msg">B·∫°n ch·∫Øc ch·∫Øn ch·ª©?</div>
                <div class="dialog-btn-row">
                    <button class="d-btn cancel" onclick="closeDialog(false)">Hu·ª∑</button>
                    <button class="d-btn confirm" onclick="closeDialog(true)">OK Ch·ªët</button>
                </div>
            </div>
        </div>

        <header>
            <div class="header-top">
                <div class="brand">Love Schedule <span class="live-dot"></span></div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-icon" onclick="sendPoke()"><i class="fa-solid fa-hand-point-right"></i></button>
                    <button class="btn-icon" onclick="openModal('stats')"><i class="fa-solid fa-chart-pie"></i></button>
                    <button class="btn-icon" onclick="openModal('settings')"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>

            <div class="week-toggle">
                <div class="week-btn active" id="wk-btn-0" onclick="setWeek(0)">Tu·∫ßn N√†y</div>
                <div class="week-btn" id="wk-btn-1" onclick="setWeek(1)">Tu·∫ßn Sau</div>
            </div>

            <div class="date-strip" id="date-strip"></div>
        </header>

        <div id="main-view">
            <div class="sticky-user-bar">
                <div class="user-pill" style="color:var(--primary)" onclick="toggleMood('Giang')">
                    <div class="avatar">G</div> 
                    <div>Giang <span class="pet-icon" id="pet-Giang">üê∂</span></div>
                    <span class="points-badge" id="pt-Giang">0</span>
                </div>
                <div class="user-pill" style="color:var(--secondary)" onclick="toggleMood('Huyen')">
                    <div class="avatar">H</div> 
                    <div>Huy·ªÅn <span class="pet-icon" id="pet-Huyen">üê±</span></div>
                    <span class="points-badge" id="pt-Huyen">0</span>
                </div>
            </div>

            <div class="grid-wrapper" id="grid-area">
                <div id="col-giang" class="col-area"></div>
                <div id="col-huyen" class="col-area"></div>
                
                <div id="now-line">
                    <div id="now-line-time">00:00</div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openAddModal()"><i class="fa-solid fa-plus"></i></button>

        <div id="modal-add" class="modal-overlay">
            <div class="modal-card">
                <div class="handle"></div>
                <div class="modal-title">Th√™m l·ªãch m·ªõi ‚ú®</div>
                <div class="toggle-group">
                    <button id="btn-u-Giang" onclick="setFormUser('Giang')" class="toggle-btn active g">Giang</button>
                    <button id="btn-u-Huyen" onclick="setFormUser('Huyen')" class="toggle-btn">Huy·ªÅn</button>
                </div>
                <div class="cat-scroll" id="cat-list"></div>
                <div class="inp-group">
                    <i class="fa-solid fa-pen" style="color:var(--text-sub)"></i>
                    <input type="text" id="inp-title" class="inp" placeholder="L√†m g√¨ ƒë√≥...">
                </div>
                <div style="margin-top:20px; margin-bottom:10px">
                    <div class="time-display">
                        <span id="txt-start">09:00</span>
                        <i class="fa-solid fa-arrow-right" style="font-size:14px; opacity:0.5; margin-top:5px"></i>
                        <span id="txt-end">11:00</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-track"></div>
                        <div class="slider-track-fill" id="slider-fill"></div>
                        <input type="range" min="0" max="24" step="0.5" value="9" id="range-1" class="range-inp" oninput="updateSlider()">
                        <input type="range" min="0" max="24" step="0.5" value="11" id="range-2" class="range-inp" oninput="updateSlider()">
                    </div>
                </div>
                <button onclick="saveTask()" class="btn-main">L∆∞u L·ªãch</button>
            </div>
            <div class="absolute inset-0" onclick="closeModal('add')" style="height:100%; width:100%; position:absolute; z-index:-1"></div>
        </div>

        <div id="modal-stats" class="modal-overlay">
            <div class="modal-card">
                <div class="handle"></div>
                <div class="modal-title">R·∫°p Chi·∫øu Phim T√¨nh Y√™u üçø</div>
                <div class="legend-row">
                    <div class="legend-item"><div class="dot" style="background:#4ade80"></div> R·∫£nh</div>
                    <div class="legend-item"><div class="dot" style="background:#fbbf24"></div> L·ªách</div>
                    <div class="legend-item"><div class="dot" style="background:#ef4444; opacity:0.5"></div> B·∫≠n</div>
                </div>
                <div id="stats-body" style="overflow-y:auto; max-height:50vh; padding-right:5px"></div>
                <div id="smart-dating-popup" class="smart-dating-card">
                    <div style="font-size:30px">üíñ</div>
                    <div style="font-weight:700; color:#db2777; margin:5px 0">C∆° h·ªôi v√†ng!</div>
                    <div style="font-size:13px; margin-bottom:10px">C·∫£ hai ƒë·ªÅu r·∫£nh t·ª´ <span id="smart-time"></span>.</div>
                    <button class="smart-btn" onclick="quickAddDate()">Ch·ªët k√®o Date nha?</button>
                </div>
                <div id="stats-msg"></div>
            </div>
            <div class="absolute inset-0" onclick="closeModal('stats')" style="height:100%; width:100%; position:absolute; z-index:-1"></div>
        </div>

        <div id="modal-settings" class="modal-overlay">
            <div class="modal-card">
                <div class="handle"></div>
                <div class="modal-title">C√†i ƒë·∫∑t ‚öôÔ∏è</div>
                <p style="font-weight:700; margin-bottom:10px">Ch·ªçn giao di·ªán</p>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div onclick="setTheme('sunset')" style="height:50px; background:linear-gradient(135deg, #FF9A9E, #FECFEF); border-radius:12px; cursor:pointer; border:2px solid transparent" class="theme-opt"></div>
                    <div onclick="setTheme('ocean')" style="height:50px; background:linear-gradient(135deg, #a5f3fc, #2563eb); border-radius:12px; cursor:pointer; border:2px solid transparent" class="theme-opt"></div>
                    <div onclick="setTheme('dark')" style="height:50px; background:linear-gradient(135deg, #0f172a, #334155); border-radius:12px; cursor:pointer; border:2px solid transparent" class="theme-opt"></div>
                </div>
                <button onclick="resetData()" style="width:100%; padding:15px; border-radius:16px; background:#fee2e2; color:#ef4444; border:none; font-weight:700">
                    <i class="fa-solid fa-trash"></i> X√≥a l·ªãch ng√†y n√†y
                </button>
            </div>
            <div class="absolute inset-0" onclick="closeModal('settings')" style="height:100%; width:100%; position:absolute; z-index:-1"></div>
        </div>
    </div>

    <script>
        /* --- CONFIG FIREBASE --- */
        const firebaseConfig = { 
            apiKey : "AIzaSyAb14CBAprIN6zJVa_c6nDKCoRq-eMcyBg" , 
            authDomain : "loveschedule-d0297.firebaseapp.com" , 
            databaseURL : "https://loveschedule-d0297-default-rtdb.firebaseio.com" , 
            projectId : "loveschedule-d0297" , 
            storageBucket : "loveschedule-d0297.firebasestorage.app" , 
            messagingSenderId : "495772360588" , 
            appId : "1:495772360588:web:f816fab7d24cea06d640a9" , 
            measurementId : "G-L83E6GRM6Y" 
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        /* --- CONSTANTS & STATE --- */
        const DAYS = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
        const CATS = [
            {id:'study', icon:'üìö', name:'H·ªçc'},
            {id:'work', icon:'üíª', name:'L√†m'},
            {id:'date', icon:'üçø', name:'H·∫πn'},
            {id:'game', icon:'üéÆ', name:'Game'},
            {id:'eat', icon:'üçú', name:'ƒÇn'},
            {id:'sleep', icon:'üò¥', name:'Ng·ªß'}
        ];
        const MOODS = ['üòä','ü•∞','üò§','üò≠','ü§Ø','üò¥'];
        const PET_G = ['üê∂','üêï','üê©','üå≠','üêï‚Äçü¶∫'];
        const PET_H = ['üê±','üêà','üêà‚Äç‚¨õ','ü¶Å','üòΩ'];

        let state = {
            dayIdx: new Date().getDay() === 0 ? 6 : new Date().getDay() - 1,
            weekOffset: 0, // 0 = Tu·∫ßn n√†y, 1 = Tu·∫ßn sau
            user: 'Giang',
            cat: 'study',
            // ƒê·ªîI SANG OBJECT MAP THEO NG√ÄY (YYYY-MM-DD) ƒê·ªÇ KH√îNG B·ªä L·ªñI L·ªÜCH TU·∫¶N
            data: {}, 
            moods: { Giang: 0, Huyen: 1 },
            points: { Giang: 0, Huyen: 0 },
            theme: localStorage.getItem('ls_theme') || 'sunset',
            smartStart: 0, smartEnd: 0
        };

        let dialogCallback = null;

        /* --- CORE FUNCTIONS --- */
        document.addEventListener('DOMContentLoaded', () => {
            setTheme(state.theme);
            renderDays();
            renderTimeMarkers();
            renderFormUI();
            
            setTimeout(() => { document.getElementById('splash').style.opacity = 0; setTimeout(()=>document.getElementById('splash').style.display='none',500); }, 1500);

            // Sync Data (D√πng b·∫£ng m·ªõi v3 ƒë·ªÉ reset format d·ªØ li·ªáu l∆∞u theo ng√†y th·ª±c t·∫ø)
            db.ref('schedule_data_v3').on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    state.data = val.data || {};
                    state.moods = val.moods || state.moods;
                    state.points = val.points || { Giang: 0, Huyen: 0 };
                }
                renderBoard();
                updateUserBar();
            });

            // Listen for Poke
            db.ref('poke').on('value', (snap) => {
                const val = snap.val();
                if(val && val.ts > Date.now() - 5000 && val.from !== state.user) {
                    showToast(`${val.from} v·ª´a ch·ªçc b·∫°n!`, 'check');
                    spawnHearts();
                    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
            });

            setTimeout(() => {
                const h = new Date().getHours();
                document.getElementById('main-view').scrollTop = (h * 80) - 150;
            }, 800);

            updateClock(); setInterval(updateClock, 60000);
        });

        function sync() {
            db.ref('schedule_data_v3').set({ 
                data: state.data, 
                moods: state.moods, 
                points: state.points 
            }).catch(() => showToast('L·ªói m·∫°ng', 'error'));
        }

        /* --- DIALOG T√ôY CH·ªàNH --- */
        function showConfirm(title, msg, callback) {
            document.getElementById('d-title').innerText = title;
            document.getElementById('d-msg').innerText = msg;
            document.getElementById('dialog-overlay').classList.add('show');
            dialogCallback = callback;
        }
        function closeDialog(confirmed) {
            document.getElementById('dialog-overlay').classList.remove('show');
            if(confirmed && dialogCallback) dialogCallback();
            dialogCallback = null;
        }

        /* --- WEEK & DAY L·∫§Y CHU·∫®N ƒê·ªäNH D·∫†NG NG√ÄY --- */
        function getDateKey(weekOffset, dayIdx) {
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 6 : today.getDay() - 1; // T2(0) -> CN(6)
            
            // T√≠nh ng√†y b·∫Øt ƒë·∫ßu c·ªßa tu·∫ßn hi·ªán t·∫°i (Th·ª© 2)
            const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - currentDay);
            // C·ªông th√™m tu·∫ßn v√† ng√†y ƒëang tr·ªè t·ªõi
            startOfWeek.setDate(startOfWeek.getDate() + (weekOffset * 7) + dayIdx);
            
            const yyyy = startOfWeek.getFullYear();
            const mm = String(startOfWeek.getMonth() + 1).padStart(2, '0');
            const dd = String(startOfWeek.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function setWeek(offset) {
            state.weekOffset = offset;
            document.getElementById('wk-btn-0').className = `week-btn ${offset===0?'active':''}`;
            document.getElementById('wk-btn-1').className = `week-btn ${offset===1?'active':''}`;
            renderDays();
            renderBoard();
        }

        function renderDays() {
            const el = document.getElementById('date-strip');
            el.innerHTML = '';
            
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 6 : today.getDay() - 1;
            const startOfThisWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - currentDay);
            
            const startOfWeek = new Date(startOfThisWeek);
            startOfWeek.setDate(startOfWeek.getDate() + (state.weekOffset * 7));

            DAYS.forEach((d, i) => {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                const dayNum = date.getDate();
                
                const div = document.createElement('div');
                div.className = `day-chip ${i===state.dayIdx ? 'active' : ''}`;
                div.innerHTML = `<span>${d}</span><span>${dayNum}</span>`;
                div.onclick = () => {
                    state.dayIdx = i; 
                    renderDays(); 
                    renderBoard();
                };
                el.appendChild(div);
            });
        }

        /* --- RENDER BOARD --- */
        function renderTimeMarkers() {
            const wrapper = document.getElementById('grid-area');
            let html = '';
            for(let i=0; i<=23; i++) {
                html += `<div class="time-marker" style="top:${i*80}px">${i}:00</div>`;
            }
            wrapper.innerHTML = html + 
                '<div id="col-giang" class="col-area"></div>' + 
                '<div id="col-huyen" class="col-area"></div>' + 
                '<div id="now-line"><div id="now-line-time">00:00</div></div>';
        }

        function renderBoard() {
            const dateKey = getDateKey(state.weekOffset, state.dayIdx);
            const d = state.data[dateKey] || { Giang: [], Huyen: [] };
            renderCol('giang', d.Giang || [], 'Giang');
            renderCol('huyen', d.Huyen || [], 'Huyen');
            
            // ·∫®n thanh tia Laser n·∫øu kh√¥ng ph·∫£i ng√†y h√¥m nay
            const today = new Date();
            const currentDay = today.getDay() === 0 ? 6 : today.getDay() - 1;
            if (state.weekOffset === 0 && state.dayIdx === currentDay) {
                document.getElementById('now-line').style.display = 'block';
            } else {
                document.getElementById('now-line').style.display = 'none';
            }
        }

        function renderCol(id, tasks, user) {
            const el = document.getElementById(`col-${id}`);
            el.innerHTML = '';
            tasks.forEach((t, i) => {
                const cat = CATS.find(c => c.id === t.cat) || CATS[0];
                const div = document.createElement('div');
                div.className = `task u-${user} ${t.done ? 'done' : ''}`;
                div.style.top = (t.start * 80 + 2) + 'px';
                div.style.height = ((t.end - t.start) * 80 - 4) + 'px';
                div.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">${cat.icon} ${t.title}</div>
                        <div class="btn-check" onclick="event.stopPropagation(); toggleDone(${i}, '${user}')">
                            <i class="fa-solid fa-check" style="font-size:10px; color:white; display:${t.done?'block':'none'}"></i>
                        </div>
                    </div>
                    <div class="task-time">${formatTime(t.start)} - ${formatTime(t.end)}</div>
                    <div class="btn-del" onclick="event.stopPropagation(); delTask(${i}, '${user}')"><i class="fa-solid fa-xmark"></i></div>
                `;
                el.appendChild(div);
            });
        }

        /* --- CLOCK --- */
        function updateClock() {
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            const t = (h*80) + (m/60*80);
            
            const line = document.getElementById('now-line');
            if(line) {
                line.style.top = t + 'px';
                document.getElementById('now-line-time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
            }
        }

        /* --- ACTIONS (THAO T√ÅC DATA) --- */
        function saveTask() {
            let t = document.getElementById('inp-title').value.trim();
            const s = parseFloat(document.getElementById('range-1').value);
            const e = parseFloat(document.getElementById('range-2').value);
            
            const CUTE_TITLES = {
                study: ['C√†y deadline', 'Tu luy·ªán b√≠ k√≠p', 'H·ªçc v√¨ t∆∞∆°ng lai'],
                date: ['ƒêi tr·ªën', 'N·∫°p nƒÉng l∆∞·ª£ng', 'Date Time ‚ù§Ô∏è'],
                game: ['G√°nh team', 'Leo rank', 'Gi·∫£i c·ª©u th·∫ø gi·ªõi'],
                eat: ['ƒÇn s·∫≠p qu√°n', 'N·∫°p mana', 'ƒê√≥i qu√° r·ªìi']
            };
            if(!t) {
                const arr = CUTE_TITLES[state.cat] || [CATS.find(c=>c.id===state.cat).name];
                t = arr[Math.floor(Math.random() * arr.length)];
            }

            const dateKey = getDateKey(state.weekOffset, state.dayIdx);
            if(!state.data[dateKey]) state.data[dateKey] = {Giang:[], Huyen:[]};
            if(!state.data[dateKey].Giang) state.data[dateKey].Giang = [];
            if(!state.data[dateKey].Huyen) state.data[dateKey].Huyen = [];

            state.data[dateKey][state.user].push({title:t, start:s, end:e, cat:state.cat, done:false});
            
            sync();
            closeModal('add');
            document.getElementById('inp-title').value = '';
        }

        function toggleDone(i, u) {
            const dateKey = getDateKey(state.weekOffset, state.dayIdx);
            const task = state.data[dateKey][u][i];
            task.done = !task.done;
            if(task.done) {
                state.points[u] += 10;
                showToast(`+10 ƒëi·ªÉm cho ${u}!`, 'check');
                spawnHearts();
            } else {
                state.points[u] = Math.max(0, state.points[u] - 10);
            }
            sync();
        }

        function delTask(i, u) {
            // Thay th·∫ø window.confirm c≈©
            showConfirm('Xo√° l·ªãch n√†y?', 'B·∫•m OK s·∫Ω xo√° vƒ©nh vi·ªÖn nha!', () => {
                const dateKey = getDateKey(state.weekOffset, state.dayIdx);
                state.data[dateKey][u].splice(i, 1);
                sync();
            });
        }

        function resetData() {
            showConfirm('D·ªçn s·∫°ch ng√†y', 'B·∫°n mu·ªën xo√° s·∫°ch b√°ch l·ªãch c·ªßa ng√†y n√†y lu√¥n?', () => {
                const dateKey = getDateKey(state.weekOffset, state.dayIdx);
                state.data[dateKey] = {Giang:[], Huyen:[]};
                sync();
                closeModal('settings');
            });
        }

        /* --- STATS --- */
        function calcStats() {
            const dateKey = getDateKey(state.weekOffset, state.dayIdx);
            const d = state.data[dateKey] || {Giang:[], Huyen:[]};
            let busyG = Array(48).fill(0), busyH = Array(48).fill(0);
            
            (d.Giang||[]).forEach(t=>{ for(let k=t.start*2; k<t.end*2; k++) busyG[k]=1; });
            (d.Huyen||[]).forEach(t=>{ for(let k=t.start*2; k<t.end*2; k++) busyH[k]=1; });
            
            let freeStreak = 0;
            let foundSmart = false;
            for(let i=16; i<44; i++) { 
                if(busyG[i]===0 && busyH[i]===0) {
                    freeStreak++;
                    if(freeStreak >= 6) { 
                        state.smartStart = (i - 5) / 2;
                        state.smartEnd = (i + 1) / 2;
                        foundSmart = true;
                    }
                } else {
                    freeStreak = 0;
                }
            }

            if(foundSmart) {
                document.getElementById('smart-dating-popup').style.display = 'block';
                document.getElementById('smart-time').innerText = `${formatTime(state.smartStart)} - ${formatTime(state.smartEnd)}`;
            } else {
                document.getElementById('smart-dating-popup').style.display = 'none';
            }

            const sessions = [
                { name: 'S√°ng', start: 6, end: 12 },
                { name: 'Chi·ªÅu', start: 12, end: 18 },
                { name: 'T·ªëi', start: 18, end: 24 }
            ];
            let html = '';
            let totalFree = 0;
            sessions.forEach(sess => {
                html += `<div class="session-title">${sess.name}</div><div class="cinema-grid">`;
                for(let h=sess.start; h<sess.end; h++) {
                    let status = 'free'; 
                    const s1 = h*2, s2 = h*2+1;
                    const bG = busyG[s1] || busyG[s2];
                    const bH = busyH[s1] || busyH[s2];
                    
                    if(bG && bH) status = 'busy';
                    else if(bG || bH) status = 'mix';
                    
                    if(status === 'free') totalFree++;
                    html += `<div class="seat-item ${status}"><div>${h}h</div></div>`;
                }
                html += `</div>`;
            });

            document.getElementById('stats-body').innerHTML = html;
            const msg = totalFree > 0 
                ? `<div>T√¨m th·∫•y <b>${totalFree} gi·ªù</b> r·∫£nh chung!</div><div style="font-size:12px; opacity:0.9; margin-top:4px">M√†u xanh l√† ch√¢n √°i üíö</div>` 
                : `<div>K√≠n l·ªãch r·ªìi ü•∫</div>`;
            document.getElementById('stats-msg').innerHTML = `<div class="stats-verdict">${msg}</div>`;
        }

        function quickAddDate() {
            const dateKey = getDateKey(state.weekOffset, state.dayIdx);
            if(!state.data[dateKey]) state.data[dateKey] = {Giang:[], Huyen:[]};
            if(!state.data[dateKey].Giang) state.data[dateKey].Giang = [];
            if(!state.data[dateKey].Huyen) state.data[dateKey].Huyen = [];

            const task = { title: "Date Night üíñ", start: state.smartStart, end: state.smartEnd, cat: "date", done: false };
            state.data[dateKey].Giang.push(task);
            state.data[dateKey].Huyen.push(task);
            sync();
            closeModal('stats');
            showToast('ƒê√£ l√™n k√®o Date!', 'check');
            spawnHearts();
        }

        /* --- STANDARD UI --- */
        function openModal(id) {
            document.getElementById(`modal-${id}`).classList.add('open');
            if(id === 'stats') calcStats();
        }
        function closeModal(id) { document.getElementById(`modal-${id}`).classList.remove('open'); }
        
        function openAddModal() {
            openModal('add');
            setFormUser(state.user);
            const h = new Date().getHours();
            document.getElementById('range-1').value = h;
            document.getElementById('range-2').value = h + 1.5;
            updateSlider();
        }

        function updateSlider() {
            const r1 = document.getElementById('range-1');
            const r2 = document.getElementById('range-2');
            let val1 = parseFloat(r1.value);
            let val2 = parseFloat(r2.value);
            if (val1 >= val2) { val1 = val2 - 0.5; r1.value = val1; } 
            const percent1 = (val1 / 24) * 100;
            const percent2 = (val2 / 24) * 100;
            const fill = document.getElementById('slider-fill');
            fill.style.left = percent1 + "%";
            fill.style.width = (percent2 - percent1) + "%";
            document.getElementById('txt-start').innerText = formatTime(val1);
            document.getElementById('txt-end').innerText = formatTime(val2);
        }
        function formatTime(val) {
            const h = Math.floor(val);
            const m = (val - h) * 60;
            return `${h.toString().padStart(2,'0')}:${m===0?'00':m}`;
        }
        function setFormUser(u) {
            state.user = u;
            document.getElementById('btn-u-Giang').className = `toggle-btn ${u==='Giang'?'active g':''}`;
            document.getElementById('btn-u-Huyen').className = `toggle-btn ${u==='Huyen'?'active h':''}`;
        }
        function renderFormUI() {
            const cel = document.getElementById('cat-list');
            CATS.forEach(c => {
                const b = document.createElement('div');
                b.className = 'cat-btn';
                b.innerHTML = `${c.icon} ${c.name}`;
                b.onclick = () => {
                    state.cat = c.id;
                    Array.from(cel.children).forEach(x => x.classList.remove('selected'));
                    b.classList.add('selected');
                };
                cel.appendChild(b);
            });
            cel.children[0].classList.add('selected');
        }

        function sendPoke() {
            db.ref('poke').set({ from: state.user, ts: Date.now() });
            showToast(`ƒê√£ ch·ªçc ${state.user==='Giang'?'Huy·ªÅn':'Giang'}!`, 'check');
            spawnHearts();
        }
        function spawnHearts() {
            for(let i=0; i<10; i++) {
                const heart = document.createElement('div');
                heart.innerHTML = '‚ù§Ô∏è';
                heart.className = 'floating-heart';
                heart.style.left = Math.random() * 100 + 'vw';
                heart.style.top = '100vh';
                heart.style.animationDuration = (Math.random() * 1 + 1) + 's';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 2000);
            }
        }
        function toggleMood(u) { state.moods[u] = (state.moods[u] + 1) % MOODS.length; sync(); }
        function updateUserBar() {
            const mG = state.moods.Giang;
            const mH = state.moods.Huyen;
            document.getElementById('pet-Giang').innerText = (mG < 2) ? PET_G[0] : PET_G[2]; 
            document.getElementById('pet-Huyen').innerText = (mH < 2) ? PET_H[0] : PET_H[3]; 
            document.getElementById('pt-Giang').innerText = state.points.Giang;
            document.getElementById('pt-Huyen').innerText = state.points.Huyen;
        }
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fa-solid fa-${type==='error'?'circle-exclamation':'check-circle'}" style="color:${type==='error'?'#f87171':'#4ade80'}"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        function setTheme(t) {
            state.theme = t;
            localStorage.setItem('ls_theme', t);
            document.documentElement.setAttribute('data-theme', t);
            document.querySelectorAll('.theme-opt').forEach(el => {
                if(el.getAttribute('onclick').includes(t)) el.style.border = "2px solid var(--text-main)";
                else el.style.border = "2px solid transparent";
            });
        }
    </script>
</body>
</html>
